---
title: 'RSE Survey 2016'
author: "Olivier PHILIPPE"
date: "26 June 2016"
output:
    html_document:
        keep_md: yes
        number_sections: yes
        toc_depth: 4
    github_document:
        md_extensions: -autolink_bare_uris+hard_line_breaks
---

```{r package_options, include=FALSE}
    # Specfy the output format
    options(knitr.table.format = 'markdown')
```

```{r echo=FALSE}
    # Setting up the directory
    ## Work only on linux -- if it is not working needs to insert manually
    this.dir = system("pwd", intern = T) 
    setwd(this.dir)
    setwd('~/git/ssi/RSE-Survey-2016/')
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
    # Source the functions.R file
    source('./R/functions.R')
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
    # Load all the libraries
    library('rmarkdown')
    library('knitr')
    library('ggplot2')
    library('stringr')  # To wrap the too long labels in the plots
    library('psy')
    library('reshape2')
    library('dplyr')
```


```{r echo=FALSE}
    ## LOAD FILE
    df <- read.csv('./data/592_full_clean.csv',  na.strings=c("NA","NaN", " ", ""))
```


# Socio-demographic information
## Disciplines

```{r fig.width=20, fig.height=10, echo=FALSE}
    sumQ <- singleTabFreq(df$Edu.academic.CLEAN, 'Field of Education')
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Field of Education', column= 'Percent', vertical_label=TRUE)
```

## Level of education
```{r echo=FALSE}
    # Reorder the factor
    levels(df$Edu.highest_qualification) <- c('Doctorate', 'Undergraduate/Others', 'Master Degree', 
                                              'Undergraduate/Others', 'Undergraduate/Others',
                                              'Undergraduate/Others', 'Undergraduate/Others')
    df$Edu.highest_qualification = factor(df$Edu.highest_qualification, levels(df$Edu.highest_qualification)[c(1,3,2)])
```

```{r fig.width=20, fig.height=10, echo=FALSE}

    sumQ <- singleTabFreq(df$Edu.highest_qualification, 'level of Education')
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Level of Education', column='Percent')
```

## Gender

```{r echo=FALSE}
    # Gender in IT -- Data from: https://docs.google.com/spreadsheets/d/1nr2ukhV2rNInLTR210yBKEvJowU9vfg6rkckFoi_1Io/edit#gid=349336051
    # Gender in RSE
    sumQ <- singleTabFreq(df$Socio.gender, 'Gender', order=TRUE)
    sumQ$Discipline <- c('RSE', 'RSE')
    sumQ <- melt(sumQ[c('Gender', 'Percent', 'Discipline'),])
    sumQ
    ?melt
    # Gender in IT -- Data from: https://docs.google.com/spreadsheets/d/1nr2ukhV2rNInLTR210yBKEvJowU9vfg6rkckFoi_1Io/edit#gid=349336051
    genderDf <- read.csv('data/information/gender_disciplines.csv')
    genderDf$Discipline <- as.character(genderDf$Discipline)
    genderDf
    ## TODO -- FIX THAT NOT DOING IT MANUALLY WRONG
    genderDf <- rbind(genderDf, c('RSE', '12', '88'))
    genderDf$Discipline <- as.factor(genderDf$Discipline)
    genderDf <- melt(genderDf, c('Discipline'))
    genderDf
    genderDf$value <- as.numeric(genderDf$value)
```


```{r fig.width=20, fig.height=15, echo=FALSE}
    kable(sumQ, digits=2, format = 'markdown')
    ggplot(data=genderDf[genderDf$variable =='Female',], aes(x=reorder(Discipline, value), y=value))+
        # geom_bar(stat='identity', position=position_dodge())+
        geom_bar(stat='identity', show.legend = FALSE, fill='#4A8F94', colour='#4A8F94')+
        #geom_bar(stat='identity') +
        #scale_color_brewer(palette='#4A8F94')+
        theme_minimal()+
        ylab('Percentage')+
        xlab('')+
        ggtitle('Gender in CS and RSE')+
        theme(plot.title = element_text(size=30, face='bold'))+
        theme(legend.position='none')+
        theme(legend.text=element_text(size=20))+
        theme(legend.title=element_blank())+
        theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
        theme(axis.text.x=element_text(size=20))+
    
        geom_text(aes(label=paste(value, '%')),  vjust=-0.2, size=4)
```

## Type of contract


```{r fig.width=20, fig.height=10, echo=FALSE}
    sumQ <- singleTabFreq(df$Job.contract, 'Type of contract', order=TRUE)
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Type of contract', order=FALSE)
```


## Salary

```{r fig.width=20, fig.height=10, echo=FALSE}
    sumQSalary <- singleTabFreq(df$Socio.salary, 'Salary', order=FALSE)
    # Reorder factors
    sumQSalary$Salary <- factor(sumQSalary$Salary, levels(sumQSalary$Salary)[c(10,2,3,4,5,6,7,8,9,1)])
    kable(sumQSalary, digits=2, format = 'markdown')
    plotSingleFreq(sumQSalary, 'Salary', order=FALSE)

```

### Comparison with the salary for academic staff in UK

```{r echo=FALSE, warning=FALSE, message=FALSE}
    # salaryDf <- read.xls('./data/staff_1415_table_B.xlsx', sheet='Table_B', header=True)
    salaryRaw <- read.csv('./data/staff_1415_table_B.csv')
    ## Subset only the total of salary for all and the associated percentage
    salaryDf <- salaryRaw[c(16,17,18,19,20,21), c(1, 20,21)]
    ## Rename the columns
    colnames(salaryDf) <- c('Salary', 'Total Respondends', 'Percent')
    ## Rename the range of salary to match the salary obtained in the RSE survey
    ## The range are different and an approximation is made to get the closest similarity between the two
    ## surveys. The comparison needs to be carefully interpreted as the ranges are overlapping and are not cuttin
    ## at the same salary
    salaryDf$Salary <- as.factor(as.character(salaryDf$Salary))
    levels(salaryDf$Salary) <- c('Under £25,000', 'Under £25,000', '>= £25,000 and < £34,000', 
                                 '>= £34,000 and < £45,000', '>= £45,000 and < £59,000', '>= £59,000')
    ## Rename the Percent value to remove the percent and transform into number
    salaryDf$Percent <- as.numeric(as.character(gsub('%', '',salaryDf$Percent)))
    ### Sum the multiple categories created by the recategorisation
    percent_All_UK <- as.data.frame(salaryDf %>%
                                        group_by(Salary) %>%
                                        summarise(Percent = sum(Percent)))
    percent_All_UK$type <- 'UK'
    ## Reorganise the salary from the RSE survey to match the new created categories
    sumQSalary$Salary <- as.factor(as.character(sumQSalary$Salary))
    levels(sumQSalary$Salary) <- c('>= £59,000', '>= £25,000 and < £34,000', '>= £25,000 and < £34,000', 
                                   '>= £34,000 and < £45,000', '>= £34,000 and < £45,000',
                                   '>= £45,000 and < £59,000', '>= £45,000 and < £59,000',
                                   '>= £59,000', '>= £59,000', 'Under £25,000')
                                   
    ### Sum the multiple categories created by the recategorisation
    percent_RSE <- as.data.frame(sumQSalary %>%
                                 group_by(Salary) %>%
                                 summarise(Percent = sum(Percent)))
    ### Reorder factors
    percent_RSE$Salary <- factor(percent_RSE$Salary, levels(percent_RSE$Salary)[c(5,2,3,4,1)])
    percent_RSE$type <- 'RSE'
    salaryPercentAll <- melt(rbind(percent_RSE, percent_All_UK))
```

#### Data with line only (best to see the difference)

```{r fig.width=20, fig.height=10, echo=FALSE}
    ggplot(salaryPercentAll, aes(x=as.numeric(Salary), y=value, colour=type))+
        geom_point(size=4)+
        geom_line(size=2)+
        geom_text(aes(label=paste(value, '%')), size=8,vjust=-0.2, show.legend = FALSE)+
        # geom_text(show.legend = FALSE) +  # To remove the symbol 'a' in legend because use geom_txt
        ggtitle('Comparison salary RSE vs UK')+
        theme_minimal() +
        scale_color_manual(values=c('#1F78B4', "#FF7F00"))+
        theme(legend.text=element_text(size=15)) +
        theme(legend.title=element_blank()) +
        xlab('Salary')+
        ylab('Percents')+
        scale_x_continuous(breaks = c(1, 2, 3, 4, 5), labels =levels(salaryPercentAll$Salary))+
        theme(axis.text.x =element_text(size=20))
```

#### Same data but with a mix of line and barplots

```{r fig.width=20, fig.height=10, echo=FALSE}

    ggplot(data=percent_RSE, aes(x=Salary, y=Percent, fill=Salary))+
        # geom_bar(stat='identity', position=position_dodge())+
        geom_bar(stat='identity', show.legend = FALSE)+
        # geom_line(aes(x=Salary, y=Percent, group='factor'), colour="#1F78B4", size=2)+
        geom_line(data=percent_All_UK, aes(x=Salary, y=Percent, group='factor'), colour="#FF7F00", size=2)+
        geom_point(data=percent_All_UK, aes(x=Salary, y=Percent, group='factor'), colour="#FF7F00", size=4)+
        geom_text(data=percent_All_UK, aes(label=paste(Percent, '%')),  vjust=-2, size=6, colour='#FF7F00')+
        geom_text(aes(label=paste(Percent, '%')),  vjust=-0.2, size=6)+
        scale_fill_manual(values =c('#1F78B4', '#1F78B4', '#1F78B4', '#1F78B4', '#1F78B4'))+
        theme_minimal()+
        ylab('Percentages')+
        xlab('')+
        ggtitle('Comparison Salary between RSE and UK academic staff')+
        theme(plot.title = element_text(size=30, face='bold'))+
        # scale_colour_manual(name="Population",
                            # values=c("#1F78B4",'#FF7F00'),
                            # labels=c('RSE', 'UK'), guide='legend')
        theme(axis.text.x =element_text(size=20))+
        theme(legend.position='none')
        # theme(legend.text=element_text(size=20))+
        # theme(legend.title=element_blank())+
        # theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
```



#### Same data but with bar plot only

```{r fig.width=20, fig.height=10, echo=FALSE}
    ggplot(salaryPercentAll, aes(Salary, y=value, fill=type))+
        geom_bar(stat='identity', position=position_dodge(width=1)) +
        geom_text(aes(label=paste(value, '%')), size=8,vjust=-0.2, position=position_dodge(width = 1))+
        ggtitle('Contribution to Papers')+
        theme_minimal() +
        scale_fill_manual(values = c('#1F78B4', "#FF7F00"))+
        # scale_color_manual(values=c('#1F78B4', "#FF7F00"))+
        # scale_fill_brewer(palette='Paired')+
        theme(legend.text=element_text(size=15)) +
        theme(axis.text.x =element_text(size=20))+
        theme(legend.title=element_blank())

```


# Good practices

## Bus Factor

```{r fig.width=20, fig.height=10, echo=FALSE}
    sumQ <- singleTabFreq(df$Stability.bus_factor, 'Bus Factor', order=FALSE)
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Bus Factor', column = 'Percent', order=FALSE)
```

## Technical hand over

```{r fig.width=20, fig.height=10, echo=FALSE}
  # Plot
    sumQ <- singleTabFreq(df$Stability.hand_over, 'Technical hand over', order=TRUE)
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Technical hand over', column = 'Percent', order=TRUE)
```


## Contribution papers

```{r fig.width=20, fig.height=10, echo=FALSE}
    sumQ <- singleTabFreq(df$Contrib.YN, 'Contribution to paper')
    kable(sumQ, digits=2, format = 'markdown')
    plotSingleFreq(sumQ, 'Contribution to paper', column = 'Percent', order=TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
    ## FIXME -- DONE IN A RUSH AND EVEN MANUALLY ENTER THE %. NEED TO REDO ALL THIS BIT
    dfContrib <- data.frame('Contribution'=df$Contrib.YN, 'Acknowledged'=df$Contrib.acknowledgedYN,
                            'Co-author'=df$Contrib.co.authorYN, 'Lead-author'=df$Contrib.leadYN)
    # summary(dfContrib$Contribution)
    dfContribMelt <- melt(dfContrib)
    contribSum <- singleTabFreq(df$Contrib.YN, 'Answer')
    contribSum$Type.Participation <- 'Contribution to paper' 
    
    df1 <- as.data.frame(summary(na.omit(dfContrib$Contribution)))
    df2 <- as.data.frame(summary(na.omit(dfContrib$Acknowledged)))
    df3 <- as.data.frame(summary(na.omit(dfContrib$Co.author)))
    df4 <- as.data.frame(summary(na.omit(dfContrib$Lead.author)))
    dfTest <- merge(df1, df2)
    dfTest <- merge(dfTest, df3)
    dfTest <- merge(dfTest, df4)
    dfTest <- dfTest[c(1, 16),]
    rownames(dfTest) <- c('No', 'Yes')
    colnames(dfTest) <- c('1.Contribution', '2.Acknowledged', '3.Co-author', '4.Lead-author')
    dfTestMelt <- as.data.frame(t(dfTest))
    dfTestMelt$Paper <- rownames(dfTestMelt)
    dfTestMelt <- melt(dfTestMelt)
    dfTestMelt$Percent <- c((27/(27+230))*100, 
                          (55/(55+174))*100,
                          (72/(72+158))*100,
                          (139/(139+91))*100,
                          (230/(230+27))*100,
                          (174/(174+55))*100,
                          (158/(158+72))*100,
                          (91/(91+139))*100)
    
    colnames(dfTestMelt) <- c('Participation', 'Answer', 'value', 'Percent')
    # dfTestMelt
```


```{r fig.width=20, fig.height=10, echo=FALSE}
    ggplot(dfTestMelt, aes(Participation, y=Percent, fill=Answer))+
        geom_bar(stat='identity', position=position_dodge(width=1)) +
        geom_text(aes(label=paste(round(Percent), '%')), size=8,vjust=-0.2, position=position_dodge(width = 1))+
        ggtitle('Contribution to Papers')+
        theme_minimal() +
        scale_fill_manual(values = c("#FF7F00", '#1F78B4'))+
        # scale_fill_brewer(palette='Paired')+
        theme(legend.text=element_text(size=15)) +
        theme(axis.text.x =element_text(size=20))+
        theme(legend.title=element_blank())
```

## Work Indicators

```{r echo=FALSE, nessage=FALSE}
    ## Create df
    dfIndicators <- data.frame('Turnover intention'=df$TurnOver.Agg, 'Perceived Employability'=df$PercEmp.Agg,
                               'Satisfaction'=df$AffSat.Agg, 'Recognition'=df$AffRec.Agg,
                               'Feedback'= df$PerfCheck.Agg)

    dfIndicatorsMelt <- melt(dfIndicators)
```

```{r fig.width=20, fig.height=10, echo=FALSE}
    ggplot(dfIndicatorsMelt, aes(x=variable, y=value, color=variable))+
         geom_boxplot(show.legend=FALSE, size=2)+
         geom_jitter(alpha=0.25, color='Grey')+
         scale_color_brewer(palette='Paired') +
         theme_minimal() +
         ylab('Mean of Aggregate score') +
         xlab('') +
         ggtitle('Work Indicators') +
         theme(plot.title = element_text(size=30, face='bold')) +
         theme(legend.text=element_text(size=20)) +
         theme(axis.text.x =element_text(size=20))+
         theme(legend.title=element_blank())
```

## Career path

```{r echo=FALSE, message=FALSE, warning=FALSE}
    ## Create the df
    dfCareer <- data.frame('Career Plan'=df$ProgRSE.1.Recode, 'Next Position'=df$ProgRSE.2.Recode, 
                           'Promotion'=df$ProgRSE.3.Recode, 'Information'=df$ProgRSE.4.Recode,
                           'Opportunities'=df$ProgRSE.5.Recode)
    dfCareerMelt <- melt(dfCareer)
    # summary(dfCareer$Career.Plan)
    # sd(dfCareer$Career.Plan, na.rm = TRUE)
    # summary(dfCareer$Next.Position)
    # sd(dfCareer$Next.Position, na.rm=TRUE)
    # summary(dfCareer$Promotion)
    # sd(dfCareer$Promotion, na.rm=TRUE)
    # summary(dfCareer$Information)
    # sd(dfCareer$Information, na.rm=TRUE)
    # summary(dfCareer$Opportunities)
    # sd(dfCareer$Opportunities, na.rm = T)
```    


```{r fig.width=20, fig.height=10, echo=FALSE}
    ggplot(na.omit(dfCareerMelt), aes(x=variable, y=value, color=variable))+
        geom_boxplot(show.legend=FALSE, size=2)+
        geom_jitter(alpha=0.25, color='Grey')+
        scale_color_brewer(palette='Paired') +
        theme_minimal() +
        ylab('Score') +
        xlab('') +
        ggtitle('Career path') +

        theme(plot.title = element_text(size=30, face='bold')) +
        theme(legend.text=element_text(size=20)) +
        theme(axis.text.x =element_text(size=20))+
        theme(legend.title=element_blank())
```



# Word cloud

## Important skills

```{r echo=FALSE}
    ### Most important skills
    skill1_important <- df$Misc.skill.imp.1
    skill2_important <- df$Misc.skill.imp.2
    skill3_important <- df$Misc.skill.imp.3
    skills_important <- c(as.character(skill1_important),
                          as.character(skill2_important),
                          as.character(skill3_important))
    wordToRemove <- c('skills', 'ability', 'skill')
    skills_important <- cleanText(skills_important, wordToRemove = wordToRemove)
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
    wordcloud(skills_important, random.color=FALSE, colors=brewer.pal(12, "Paired"))
```


### Skills to improve

```{r echo=FALSE}
  skills1_to_improve <- df$Misc.skill.better.1
  skills2_to_improve <- df$Misc.skill.better.2
  skills3_to_improve <- df$Misc.skill.better.3
  skills_improve <- c(as.character(skills1_to_improve),
                      as.character(skills2_to_improve),
                      as.character(skills3_to_improve))
  skills_improve <- cleanText(skills_improve, wordToRemove = wordToRemove)
  wordToRemove <- c('skill', 'skills', 'better', 'improve')
```
 
```{r echo=FALSE, warning=FALSE, message=FALSE}
  wordcloud(skills_improve, random.color=FALSE, colors=brewer.pal(12, "Paired"))
```

### Tools used

```{r echo=FALSE, message=FALSE, warning=FALSE}
  tool1 <- df$Misc.tool.1
  tool2 <- df$Misc.tool.2
  tool3 <- df$Misc.tool.3
  all_tools <- c(as.character(tool1),
                 as.character(tool2),
                 as.character(tool3))

  all_tools <- cleanText(all_tools, wordToRemove = c('tools', 'system'))
```


```{r echo=FALSE, warning=FALSE, message=FALSE}
    wordcloud(all_tools, random.color=FALSE, colors=brewer.pal(12, "Paired"))
```